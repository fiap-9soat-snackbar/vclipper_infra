# VClipper Video Storage Infrastructure

This Terraform configuration provisions AWS S3 bucket for secure video storage and generated image clips, with pre-signed URL access and automatic lifecycle management for the VClipper application.

## 🚀 Features

- **Secure S3 Bucket**: Private bucket with public access blocked for maximum security
- **Pre-signed URL Access**: Secure upload/download via time-limited URLs generated by backend
- **Automatic Lifecycle Management**: Videos (15 days) and clips (45 days) retention with cleanup
- **CORS Configuration**: Dynamic frontend URL integration from remote state
- **Organized Storage**: Structured prefixes for videos, clips, and temporary files
- **Encryption**: Server-side AES256 encryption for all stored files

## 📐 Current Architecture

```
React Frontend → Backend APIs (LabRole) → S3 Video Storage
     ↓              ↓                        ↓
Pre-signed URLs → Generate URLs → Store/Retrieve Files
     ↓              ↓                        ↓
Upload/Download → S3 Operations → Encrypted Storage
```

## 🛠️ Project Structure

```
.
├── s3.tf                   # S3 bucket configuration and security
├── variables.tf            # Input variable definitions
├── outputs.tf              # Output value definitions
├── backend.tf              # Terraform backend and provider configuration
├── terraform.tfvars        # Variable values (gitignored)
└── README.md               # This documentation
```

## 🛠️ Terraform Resources

| Resource Type | Purpose |
|---------------|---------|
| `aws_s3_bucket` | Creates the S3 bucket for video and clip storage |
| `aws_s3_bucket_versioning` | Enables versioning for file history |
| `aws_s3_bucket_server_side_encryption_configuration` | Encrypts stored files with AES256 |
| `aws_s3_bucket_public_access_block` | Blocks all public access for security |
| `aws_s3_bucket_cors_configuration` | Configures CORS for frontend pre-signed URL access |
| `aws_s3_bucket_lifecycle_configuration` | Manages automatic file cleanup and retention |
| `aws_s3_bucket_notification` | Placeholder for SQS integration |

## 🚀 Deployment

### Prerequisites
1. **AWS CLI Configured** with valid credentials and LabRole access
2. **Terraform v1.12+** installed
3. **Global Terraform State** deployed (for project name and region)
4. **Frontend Hosting Service** deployed (for CORS configuration)

### Configuration Variables
- `environment`: Environment name (default: "dev")
- `video_retention_days`: Days to retain videos (default: 15)
- `images_retention_days`: Days to retain image clips (default: 45)
- `max_video_size_mb`: Maximum video file size (default: 500)
- `allowed_origins`: Additional CORS origins (frontend URLs auto-added)

## 🛠️ How to Run Terraform

### One-time Initialization (Required for new developers)
Before running plan/apply for the first time, initialize the backend:
```bash
terraform init -backend-config="bucket=$(grep bucket terraform.tfvars | cut -d'=' -f2 | tr -d ' "')"
```

### Regular Operations
After initialization, you can run normal Terraform commands:
```bash
# Preview changes
terraform plan

# Apply changes
terraform apply

# Destroy resources (if needed)
terraform destroy
```

**Note:** The `terraform.tfvars` file contains the state bucket name and is automatically used by Terraform.

## 📁 Bucket Structure

After deployment, your S3 bucket will be organized as:

```
vclipper-video-storage-dev/
├── videos/                 # Uploaded videos (15 days retention)
│   ├── user123/
│   │   ├── video1.mp4
│   │   └── video2.avi
│   └── user456/
│       └── video3.mov
├── clips/                  # Generated image clips (45 days retention)
│   ├── user123/
│   │   ├── video1_clips.zip
│   │   └── video2_clips.zip
│   └── user456/
│       └── video3_clips.zip
└── temp/                   # Temporary processing files (1 day retention)
    ├── processing_video1.tmp
    └── processing_video2.tmp
```

## 🔒 Security Configuration

The S3 bucket provides maximum security:

### 🔒 **Blocked Operations (Public Access):**
- All public read/write access blocked
- No public bucket policies allowed
- No public ACLs allowed
- Bucket-level public access restrictions enforced

### ✅ **Allowed Operations (Pre-signed URLs Only):**
- File uploads via backend-generated pre-signed URLs
- File downloads via backend-generated pre-signed URLs
- Backend access using LabRole permissions
- CORS-enabled access from configured frontend origins

## 🔗 Integration with Frontend and Backend

### Frontend Integration (React)
The frontend uses pre-signed URLs for secure S3 access:

```javascript
// Upload video example
const uploadVideo = async (file) => {
  // 1. Request pre-signed URL from backend
  const response = await fetch('/api/videos/upload-url', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${jwtToken}` },
    body: JSON.stringify({ 
      fileName: file.name, 
      fileType: file.type,
      fileSize: file.size 
    })
  });
  
  const { uploadUrl, key } = await response.json();
  
  // 2. Upload directly to S3
  await fetch(uploadUrl, {
    method: 'PUT',
    body: file,
    headers: { 'Content-Type': file.type }
  });
  
  return key;
};

// Download clips example
const downloadClips = async (videoId) => {
  const response = await fetch(`/api/videos/${videoId}/clips-url`, {
    headers: { 'Authorization': `Bearer ${jwtToken}` }
  });
  
  const { downloadUrl } = await response.json();
  window.open(downloadUrl, '_blank');
};
```

### Backend Integration (Java/EKS)
Backend APIs generate pre-signed URLs using LabRole:

```java
// Generate upload pre-signed URL
@PostMapping("/videos/upload-url")
public ResponseEntity<UploadUrlResponse> generateUploadUrl(
    @RequestBody UploadUrlRequest request) {
    
    String key = "videos/" + userId + "/" + UUID.randomUUID() + "_" + request.getFileName();
    
    URL presignedUrl = s3Client.generatePresignedUrl(
        GetPresignedUrlRequest.builder()
            .bucket("vclipper-video-storage-dev")
            .key(key)
            .method(HttpMethod.PUT)
            .expiration(Instant.now().plus(1, ChronoUnit.HOURS))
            .build()
    );
    
    return ResponseEntity.ok(new UploadUrlResponse(presignedUrl.toString(), key));
}
```

### Environment Variables
Add to your backend application configuration:

```bash
# S3 Configuration
S3_VIDEO_BUCKET=vclipper-video-storage-dev
S3_REGION=us-east-1
S3_VIDEO_PREFIX=videos/
S3_CLIPS_PREFIX=clips/
S3_TEMP_PREFIX=temp/

# Pre-signed URL settings
PRESIGNED_URL_EXPIRATION=3600
MAX_VIDEO_SIZE_MB=500

# Supported video types
ALLOWED_VIDEO_TYPES=video/mp4,video/avi,video/mov,video/wmv,video/flv,video/webm
```

## 🔄 Lifecycle Management

### Automatic Cleanup Rules
- **Videos (`videos/` prefix)**: Deleted after 15 days
- **Image Clips (`clips/` prefix)**: Deleted after 45 days  
- **Temporary Files (`temp/` prefix)**: Deleted after 1 day
- **Old Versions**: Deleted after 7 days for all prefixes

### Supported Video Formats
- MP4 (video/mp4)
- AVI (video/avi)
- MOV (video/mov)
- WMV (video/wmv)
- FLV (video/flv)
- WebM (video/webm)

## 🔄 Integration with SQS and SNS

### SQS Integration (Future)
When SQS service is deployed, S3 notifications will trigger video processing:

```hcl
# S3 bucket notification (configured after SQS deployment)
resource "aws_s3_bucket_notification" "video_storage" {
  bucket = aws_s3_bucket.video_storage.id

  queue {
    queue_arn     = data.terraform_remote_state.sqs.outputs.processing_queue_arn
    events        = ["s3:ObjectCreated:*"]
    filter_prefix = "videos/"
  }
}
```

### SNS Integration (Future)
SNS will notify users when video processing is complete or fails.

## 📊 Outputs

Key outputs for integration with other services:
- `bucket_name`: S3 bucket name for backend configuration
- `bucket_arn`: For IAM policy references and SQS integration
- `video_prefix`: "videos/" - for organizing uploads
- `clips_prefix`: "clips/" - for organizing generated clips
- `presigned_url_expiration`: Default URL expiration time
- `max_video_size_mb`: File size limit for validation
- `allowed_video_types`: MIME types for frontend validation

## 🔧 Troubleshooting

### Common Issues

#### 1. **CORS Errors**
```bash
# Check CORS configuration
aws s3api get-bucket-cors --bucket vclipper-video-storage-dev

# Verify frontend URLs are included
terraform output cors_origins
```

#### 2. **Upload Failures**
- Verify file size is under 500MB limit
- Check file type is in allowed list
- Ensure pre-signed URL hasn't expired (1 hour default)
- Verify CORS headers in browser network tab

#### 3. **Access Denied**
- Confirm LabRole has necessary S3 permissions
- Check bucket public access block settings
- Verify pre-signed URL generation in backend

### Useful Commands
```bash
# Check bucket contents
aws s3 ls s3://vclipper-video-storage-dev/ --recursive --human-readable

# Test bucket access
aws s3api head-bucket --bucket vclipper-video-storage-dev

# Check lifecycle configuration
aws s3api get-bucket-lifecycle-configuration --bucket vclipper-video-storage-dev

# Monitor recent uploads
aws s3 ls s3://vclipper-video-storage-dev/videos/ --recursive --human-readable

# Check encryption settings
aws s3api get-bucket-encryption --bucket vclipper-video-storage-dev
```

### Monitoring Storage Usage
```bash
# CloudWatch metrics for bucket size
aws cloudwatch get-metric-statistics \
  --namespace AWS/S3 \
  --metric-name BucketSizeBytes \
  --dimensions Name=BucketName,Value=vclipper-video-storage-dev \
  --start-time 2025-06-01T00:00:00Z \
  --end-time 2025-06-22T23:59:59Z \
  --period 86400 \
  --statistics Average
```
